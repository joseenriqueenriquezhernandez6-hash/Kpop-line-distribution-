<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>K-Pop Line Distribution (Final)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --glass: rgba(255,255,255,0.12); --glass-2: rgba(255,255,255,0.06) }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Poppins",sans-serif; -webkit-font-smoothing:antialiased;
    background: linear-gradient(135deg,#ff3cac,#784ba0,#2b86c5);
    background-size:400% 400%; color:white; padding:18px;
    animation:bgShift 12s ease infinite;
  }
  @keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .wrap{max-width:820px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  h1{margin:0;font-size:20px;font-weight:700}
  .panel{background:var(--glass); border-radius:14px; padding:12px; margin-top:14px; backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,0.06)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input[type="text"], input[type="number"]{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:white;min-width:0}
input[type="color"]{width:44px;height:38px;border-radius:8px;border:none;padding:0}
button{padding:10px 14px;border-radius:999px;border:none;cursor:pointer;font-weight:700}
.btn-primary{background:#00e5ff;color:#04121f}
.btn-neutral{background:rgba(255,255,255,0.12);color:white}
.btn-danger{background:#ff6b6b;color:white}

#members{margin-top:14px;display:flex;flex-direction:column;gap:12px}

.member {
display:flex;flex-direction:column;gap:10px;padding:12px;border-radius:12px;
background:rgba(255,255,255,0.03); /* m√°s transparente */
border:1px solid rgba(255,255,255,0.02); /* borde m√°s sutil */
transition:transform .28s,box-shadow .28s,opacity .28s;
position: relative; /* para el bot√≥n de eliminar */
}

/* Estilo para el bot√≥n de eliminar */
.delete-member-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #ff4d4d; /* Un color rojo sutil */
  color: white;
  border: none;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 1;
  opacity: 0.7;
  transition: opacity 0.2s;
}
.delete-member-btn:hover {
  opacity: 1;
}

.member-top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.left{display:flex;align-items:center;gap:12px;min-width:0}
.avatar-wrap{width:56px;height:56px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:3px solid rgba(255,255,255,0.06);transition:transform .22s,border-color .22s,box-shadow .22s}
.avatar-wrap img{width:100%;height:100%;object-fit:cover;display:block}
.avatar-initial{font-weight:700;font-size:18px;color:#fff}

.member .info{min-width:0}
.name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta{font-size:13px;opacity:0.95}

/* NOTA: progress-wrap ahora representa el 100% de la l√≠nea de distribuci√≥n total */
.progress-wrap{height:14px;border-radius:10px;background:rgba(255,255,255,0.06);overflow:hidden}
.progress{height:100%;width:0%;transition:width .12s linear;background:var(--color)}

.controls{display:flex;gap:8px;flex-wrap:wrap}
.controls button{flex:1;padding:10px;border-radius:10px}
.sing{background:#36e27a;color:#022}
.stop{background:#ff7b7b;color:white}
.disableBtn{background:#333333;color:white}

/* member singing effect */
.member.singing{transform:scale(1.03);box-shadow:0 12px 40px rgba(0,0,0,0.35)}

/* disabled look */
.member.disabled{opacity:0.6;filter:grayscale(20%)}

/* CHART STYLES */
.chart-container{margin-top:20px;padding:12px;border-radius:12px;background:var(--glass)}
.chart-display{display:flex;justify-content:center;align-items:center;min-height:200px;margin-top:10px;position:relative}

/* Pie Chart (Pastel) */
.chart-pie{width:180px;height:180px;border-radius:50%;background:conic-gradient(var(--chart-data));}
.chart-pie-wrap{position:relative;width:180px;height:180px;}
.chart-legend{position:absolute;right:0;top:0;font-size:13px;padding-left:20px;max-width:40%;}
.chart-legend-item{display:flex;align-items:center;margin-bottom:4px;}
.chart-legend-item::before{content:'';display:block;width:10px;height:10px;border-radius:2px;margin-right:6px;background:var(--color)}

/* Bar Chart (Horizontal) */
.chart-bar-horizontal-wrap{width:100%;}
.bar-h-item{display:flex;align-items:center;margin-bottom:10px;gap:10px;}
.bar-h-name{width:80px;font-size:12px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;}
.bar-h-progress-wrap{flex-grow:1;height:18px;border-radius:4px;background:rgba(255,255,255,0.06);overflow:hidden;}
.bar-h-progress{height:100%;width:var(--percent);background:var(--color);transition:width .3s ease;}

/* Bar Chart (Vertical) */
.chart-bar-vertical-wrap{width:100%;display:flex;align-items:flex-end;height:200px;gap:12px;padding:0 10px;}
.bar-v-item{flex-grow:1;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:flex-end;}
.bar-v-bar{width:100%;min-width:18px;background:var(--color);height:var(--percent);border-top-left-radius:4px;border-top-right-radius:4px;transition:height .3s ease;position:relative;}
.bar-v-label{font-size:12px;margin-top:4px;font-weight:600;white-space:nowrap;max-width:100%;overflow:hidden;text-overflow:ellipsis;}
.bar-v-value{position:absolute;top:-16px;font-size:11px;font-weight:700;color:white;text-shadow:0 0 3px #000;}

/* small responsive */
@media (max-width:600px){
.avatar-wrap{width:48px;height:48px}
.controls button{padding:9px}
.chart-display{flex-direction:column;height:auto}
.chart-legend{position:static;max-width:100%;margin-top:15px;padding-left:0;}
}
</style>

</head>
<body>
<div class="wrap">
  <header>
    <h1>K-Pop Line Distribution</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-neutral" onclick="print()">Export / Print</button>
      <button class="btn-danger" onclick="resetAll()">Reset All</button>
    </div>
  </header>
    <div class="panel">
    <div class="row" style="align-items:center">
      <div style="min-width:200px">
        <label style="display:block;font-size:13px;margin-bottom:6px">Duraci√≥n canci√≥n (min : seg) ‚Äî **Informativo**</label>
        <div style="display:flex;gap:8px">
          <input id="songMin" type="number" placeholder="min" style="width:72px">
          <span style="align-self:center">:</span>
          <input id="songSec" type="number" placeholder="seg" style="width:72px">
        </div>
      </div>
      
      <div style="flex:1;min-width:220px">
        <label style="display:block;font-size:13px;margin-bottom:6px">Agregar integrante</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="newName" type="text" placeholder="Nombre">
          <input id="newColor" type="color" value="#ff6b6b">
          <button class="btn-primary" onclick="addMember()">Agregar</button>
        </div>
      </div>
    </div>
  <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
  <button class="btn-neutral" onclick="saveAll()">Guardar distribuci√≥n</button>
  <button class="btn-neutral" onclick="loadAll()">Cargar √∫ltima</button>
  <button class="btn-neutral" onclick="resetDistribution()">Reset Distribution</button>
</div>

<div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <label style="font-size:13px">Fondo (color):</label>
  <input type="color" id="bgColor">
  <label style="font-size:13px">Fondo (imagen):</label>
  <input type="file" id="bgImage" accept="image/*">
</div>

  </div>
    <div id="members"></div>
    
    <div class="panel chart-container">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <h3 style="margin:0;font-size:16px">Gr√°fica de Distribuci√≥n (Tiempo Total: <span id="totalTimeDisplay">0.0s</span>)</h3>
            <div style="display:flex;gap:8px">
                <button class="btn-neutral" onclick="setChartType('pie')">1. Pastel</button>
                <button class="btn-neutral" onclick="setChartType('bar-h')">2. Barra Horizontal</button>
                <button class="btn-neutral" onclick="setChartType('bar-v')">3. Barra Vertical</button>
            </div>
        </div>
        <div id="chartDisplay" class="chart-display">
            Selecciona un tipo de gr√°fica y agrega al menos 1s de l√≠nea para visualizar.
        </div>
    </div>
    
</div>
<script>
let members = [];
let intervals = {};
let currentChartType = 'pie'; // Estado de la gr√°fica actual
const STORAGE_KEY = "kpop_line_dist_final_v1";

(function(){
  loadAll();
  render();
})();

function uid(){ return Date.now().toString(36) + Math.floor(Math.random()*999).toString(36); }

function getSongDurationInSeconds(){
  const min = Number(document.getElementById('songMin').value) || 0;
  const sec = Number(document.getElementById('songSec').value) || 0;
  return (min * 60) + sec;
}

document.getElementById('bgColor').addEventListener('input', e=>{
  document.body.style.backgroundImage = 'none';
  document.body.style.backgroundColor = e.target.value;
});
document.getElementById('bgImage').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ document.body.style.backgroundImage = `url(${r.result})`; document.body.style.backgroundSize='cover'; document.body.style.backgroundPosition='center'; }
  r.readAsDataURL(f);
});

function addMember(){
  const name = (document.getElementById('newName').value || "").trim();
  const color = document.getElementById('newColor').value || "#ff6b6b";
  
  if(!name){ alert("Escribe un nombre."); return; }

  members.push({ id: uid(), name, color, time:0, finalized:false, disabled:false, avatar:null });
  document.getElementById('newName').value = "";
  render();
}

function saveAll(){
  const songMin = Number(document.getElementById('songMin').value) || 0;
  const songSec = Number(document.getElementById('songSec').value) || 0;
  const payload = { members, settings: { songMin, songSec } }; 
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  alert("Guardado ‚úî");
}

function loadAll(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const parsed = JSON.parse(raw);
    members = (parsed.members||[]).map(m => ({
      id: m.id||uid(),
      name: m.name||'Member',
      color: m.color||'#ff6b6b',
      time: Number(m.time)||0,
      finalized: !!m.finalized, 
      disabled: !!m.disabled,
      avatar: m.avatar||null
    }));
    document.getElementById('songMin').value = parsed.settings?.songMin ?? "";
    document.getElementById('songSec').value = parsed.settings?.songSec ?? "";
  }catch(e){ console.error(e) }
  render();
}

function resetAll(){
  if(!confirm("¬øReiniciar TODO? Se borrar√° todo y el guardado.")) return;
  clearAllIntervals();
  members = []; localStorage.removeItem(STORAGE_KEY);
  render();
}

function resetDistribution(){
  if(!confirm("¬øBorrar el tiempo de distribuci√≥n (mantener integrantes)?")) return;
  clearAllIntervals();
  members.forEach(m => {
      m.time = 0;
      m.finalized = false; 
      m.singing = false;
  });
  render();
}

setInterval(()=> {
  try{
    const songMin = Number(document.getElementById('songMin').value) || 0;
    const songSec = Number(document.getElementById('songSec').value) || 0;
    const payload = { members, settings:{ songMin, songSec } }; 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(e){}
}, 7000);

function calculateTotalTime(){
    return members.reduce((sum, m) => sum + (m.disabled ? 0 : m.time), 0);
}

function render(){
  // Ordenar por tiempo de canto
  members.sort((a,b)=> b.time - a.time);
  const container = document.getElementById('members');
  container.innerHTML = "";
  
  const totalTime = calculateTotalTime(); 
  document.getElementById('totalTimeDisplay').textContent = totalTime.toFixed(1) + 's';
  
  members.forEach(m => {
    // CAMBIO DE L√ìGICA: Calcular porcentaje basado en el Tiempo Total Acumulado
    const percent = totalTime > 0 ? (m.time / totalTime) * 100 : 0;
    
    // ANCHO DE LA BARRA DE PROGRESO: Siempre representa el porcentaje sobre el 100% acumulado
    const progressWidth = percent; 
    
    const card = document.createElement('div');
    card.className = 'member' + (m.singing? ' singing':'') + (m.disabled? ' disabled':'');

    card.innerHTML = `
      <button class="delete-member-btn" onclick="deleteMember('${m.id}')">‚úï</button>
      <div class="member-top">
        <div class="left">
          <div class="avatar-wrap" id="avatar-${m.id}" style="--color:${m.color}">
            ${m.avatar ? `<img src="${m.avatar}" alt="${m.name}">` : `<div class="avatar-initial">${(m.name||'?').trim().charAt(0).toUpperCase()}</div>`}
          </div>
          <div class="info">
            <div class="name">${m.name}</div>
            <div class="meta">${m.time.toFixed(1)}s ‚Ä¢ ${percent.toFixed(1)}%</div> 
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center"></div>
      </div>
      <div class="progress-wrap">
        <div class="progress" id="progress-${m.id}" style="--color:${m.color}; width:${progressWidth}%"></div>
      </div>
      <div class="controls">
        <button class="sing" ${m.disabled ? 'disabled':''}>Sing</button>
        <button class="stop" ${m.disabled ? 'disabled':''}>Stop</button>
        <button class="disableBtn">${m.disabled? 'üîí':'‚ûñ'}</button>
        <button class="btn-neutral" style="min-width:36px">Subir foto</button>
      </div>
    `;

    container.appendChild(card);

    const singBtn = card.querySelector('.sing');
    const stopBtn = card.querySelector('.stop');
    const disableBtn = card.querySelector('.disableBtn');
    const uploadBtn = card.querySelector('.btn-neutral');
    const avatarWrap = card.querySelector('.avatar-wrap');

    singBtn.onclick = () => startSing(m.id);
    stopBtn.onclick = () => stopSing(m.id);
    disableBtn.onclick = () => toggleDisable(m.id);

    uploadBtn.onclick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (evt) => {
        const file = evt.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const member = members.find(x=>x.id===m.id);
          if(member){ member.avatar = reader.result; render(); }
        };
        reader.readAsDataURL(file);
      };
      input.click();
    };

    avatarWrap.style.setProperty('--color', m.color);
    if(m.singing){ avatarWrap.classList.add('singing','glow'); card.classList.add('singing'); }
    else { avatarWrap.classList.remove('singing','glow'); card.classList.remove('singing'); }

    if(m.disabled){ card.classList.add('disabled'); }
  });
  
  // Renderizar la gr√°fica despu√©s de renderizar los miembros
  renderChart(currentChartType); 
}

function deleteMember(id){
    if(!confirm("¬øSeguro que quieres eliminar a este integrante?")) return;
    stopSing(id); 
    members = members.filter(m => m.id !== id);
    render();
}

function startSing(id){
  const m = members.find(x=>x.id===id);
  if(!m || m.disabled) return; 
  if(intervals[id]) return;
  m.singing = true; render();
  intervals[id] = setInterval(()=>{
    const mm = members.find(x=>x.id===id);
    if(!mm || mm.disabled){ clearInterval(intervals[id]); delete intervals[id]; mm && (mm.singing=false); render(); return; } 
    mm.time = Number((mm.time + 0.1).toFixed(1));
    render(); // Llama a render en cada tick para actualizar el tiempo y porcentaje
  }, 100);
}

function stopSing(id){
  const m = members.find(x=>x.id===id);
  if(!m) return;
  if(intervals[id]){ clearInterval(intervals[id]); delete intervals[id]; }
  m.singing = false;
  render();
}

function toggleDisable(id){
  const m = members.find(x=>x.id===id);
  if(!m) return;
  if(!m.disabled){ if(intervals[id]){ clearInterval(intervals[id]); delete intervals[id]; } m.singing=false; m.disabled=true; }
  else { m.disabled=false; }
  render();
}

function clearAllIntervals(){
  Object.keys(intervals).forEach(k => { clearInterval(intervals[k]); delete intervals[k]; });
}

// --- Funciones de Gr√°ficas ---

function setChartType(type){
    currentChartType = type;
    renderChart(type);
}

function getChartData(){
    const totalTime = calculateTotalTime();
    if(totalTime === 0) return [];
    
    // Obtener solo miembros con tiempo > 0, ordenados por tiempo
    return members
        .filter(m => m.time > 0)
        .sort((a,b)=> b.time - a.time)
        .map(m => ({
            name: m.name,
            color: m.color,
            time: m.time,
            percent: (m.time / totalTime) * 100
        }));
}

function renderChart(type){
    const data = getChartData();
    const chartDisplay = document.getElementById('chartDisplay');
    chartDisplay.innerHTML = '';
    
    if (data.length === 0) {
        chartDisplay.innerHTML = 'Agrega al menos 1s de l√≠nea para visualizar la gr√°fica.';
        return;
    }

    const legendHTML = `<div class="chart-legend">${data.map(d => `<div class="chart-legend-item" style="--color:${d.color}">${d.name}: ${d.percent.toFixed(1)}%</div>`).join('')}</div>`;

    if (type === 'pie') {
        let gradientParts = [];
        let currentAngle = 0;

        data.forEach(d => {
            const angle = d.percent * 3.6; // 360 / 100
            gradientParts.push(`${d.color} ${currentAngle}deg ${currentAngle + angle}deg`);
            currentAngle += angle;
        });

        chartDisplay.innerHTML = `
            <div class="chart-pie-wrap">
                <div class="chart-pie" style="--chart-data: ${gradientParts.join(', ')}"></div>
            </div>
            ${legendHTML}
        `;
    } 
    else if (type === 'bar-h') {
        const barHTML = data.map(d => `
            <div class="bar-h-item">
                <div class="bar-h-name">${d.name} (${d.time.toFixed(1)}s)</div>
                <div class="bar-h-progress-wrap">
                    <div class="bar-h-progress" style="--color:${d.color}; --percent:${d.percent}%"></div>
                </div>
                <div>${d.percent.toFixed(1)}%</div>
            </div>
        `).join('');
        
        chartDisplay.innerHTML = `<div class="chart-bar-horizontal-wrap">${barHTML}</div>`;
    }
    else if (type === 'bar-v') {
        const barHTML = data.map(d => `
            <div class="bar-v-item">
                <div class="bar-v-bar" style="--color:${d.color}; --percent:${d.percent}%">
                    <div class="bar-v-value">${d.percent.toFixed(1)}%</div>
                </div>
                <div class="bar-v-label">${(d.name.length > 8 ? d.name.substring(0, 5) + '...' : d.name)}</div>
            </div>
        `).join('');

        chartDisplay.innerHTML = `
            <div class="chart-bar-vertical-wrap">${barHTML}</div>
            <p style="font-size:12px;opacity:0.8;margin-top:10px;width:100%;text-align:center;">*Los nombres largos se acortan en esta gr√°fica.</p>
        `;
    }
}

// --- Fin Funciones de Gr√°ficas ---

window.addEventListener('beforeunload', ()=> { clearAllIntervals(); });
function print(){ window.print(); }
function findIndexById(id){ return members.findIndex(m => m.id === id); }
</script>
</body>
</html>
